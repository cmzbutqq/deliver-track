# 电商物流配送可视化平台规格说明书

## 一、项目概述

电商物流配送可视化平台是一个基于 NestJS 和 React 构建的全栈物流配送管理系统，旨在为电商商家和终端用户提供完整的物流配送解决方案。系统实现了从商家创建订单、模拟发货、后端自动生成配送轨迹、用户实时追踪到自动确认收货的完整业务闭环。

系统采用前后端分离架构，后端使用 NestJS 框架提供 RESTful API 和 WebSocket 实时通信服务，前端使用 React 18 构建单页应用。数据库采用 PostgreSQL 配合 PostGIS 扩展支持地理空间数据存储和查询。系统集成了高德地图 API 实现真实路径规划和地图可视化，使用定时任务模拟配送过程，并通过 WebSocket 实时推送包裹位置信息。

项目代码结构清晰，遵循模块化设计原则。后端代码位于 backend 目录，前端代码位于 frontend 目录，文档和测试代码分别存放在 documents 和 tests 目录。系统支持完整的单元测试和端到端测试，测试覆盖率较高，核心服务如 AmapService 和地理空间计算工具达到 100% 覆盖率。

## 二、技术架构

### 2.1 后端技术栈

后端采用 NestJS 框架，这是一个基于 TypeScript 的渐进式 Node.js 框架，提供了完整的依赖注入、模块化架构和装饰器支持。数据库使用 PostgreSQL 12+ 配合 PostGIS 扩展，支持地理空间数据类型和空间查询。ORM 层使用 Prisma，提供了类型安全的数据库访问和自动生成的 TypeScript 类型定义。

认证授权采用 JWT（JSON Web Token）机制，结合 Passport.js 实现基于策略的认证。系统支持本地策略（用户名密码登录）和 JWT 策略（Token 验证）。密码使用 bcrypt 进行哈希加密存储，确保安全性。

实时通信使用 Socket.io 实现 WebSocket 连接，支持订单级别的房间隔离机制。每个订单对应一个独立的房间（Room），客户端订阅订单后加入对应房间，服务器向房间内所有客户端广播位置更新和状态变更。系统实现了首次订阅立即推送当前位置的机制，避免用户等待。

定时任务使用 @nestjs/schedule 模块，通过装饰器方式定义 Cron 任务。轨迹模拟器每 5 秒查询一次所有运输中的订单，计算下一个位置点并更新数据库，同时通过 WebSocket 推送更新。系统在启动时会自动恢复所有运输中订单的定时器，确保服务重启后配送过程不中断。

路径规划服务集成了高德地图 Web Service API，支持驾车路径规划。当 API 调用失败或未配置 API Key 时，系统自动降级到直线插值算法，确保功能可用性。路径生成采用队列机制，通过 RouteQueueService 控制并发，每半秒处理一个订单的路径生成请求，失败时自动重试最多 3 次。

### 2.2 前端技术栈

前端使用 React 18 配合 TypeScript 构建，构建工具采用 Vite，提供快速的开发体验和优化的生产构建。UI 组件库使用 Ant Design 5.x，提供了丰富的企业级组件和良好的设计规范。路由管理使用 React Router v6，支持嵌套路由和路由守卫。

地图可视化使用高德地图 JS API v2.0，支持地图渲染、标记点、路径线、热力图等丰富功能。系统封装了地图组件，统一管理地图实例的创建和销毁，避免内存泄漏。车辆图标移动使用缓动函数实现平滑动画效果，通过 requestAnimationFrame 控制动画帧率。

数据可视化使用 ECharts 5.x，支持柱状图、折线图、地理柱状图等多种图表类型。统计看板中的配送时效分析使用地理柱状图展示不同区域的配送时长，物流公司对比使用普通柱状图展示各公司的平均配送时长和准时率。

状态管理使用 Zustand，这是一个轻量级的状态管理库，相比 Redux 更加简洁。系统维护两个全局状态：authStore 用于管理用户认证状态和 Token，themeStore 用于管理主题切换（深色/浅色模式）。

WebSocket 客户端使用 socket.io-client，实现了自动重连机制。当连接断开时，客户端采用指数退避策略进行重连，最多重试 5 次。重连成功后自动重新订阅之前订阅的订单，确保用户体验连续性。

### 2.3 数据库设计

数据库使用 PostgreSQL 配合 PostGIS 扩展。PostGIS 提供了丰富的地理空间数据类型和函数，虽然当前版本主要使用 JSON 格式存储地理坐标，但为未来扩展留下了空间。

数据模型包括商家（Merchant）、订单（Order）、配送区域（DeliveryZone）、路径（Route）、物流时间线（LogisticsTimeline）和物流公司（LogisticsCompany）六个核心实体。

商家表存储商家基本信息，包括用户名、密码哈希、联系方式、默认发货地址等。密码使用 bcrypt 加密存储，默认发货地址以 JSON 格式存储，包含经度、纬度和地址描述。

订单表是核心业务实体，包含订单号、状态、商家ID、收货人信息、商品信息、金额、起止位置、当前位置、时效信息、物流公司等字段。订单状态使用枚举类型，包括待发货（PENDING）、运输中（SHIPPING）、已送达（DELIVERED）和已取消（CANCELLED）。起止位置和当前位置以 JSON 格式存储经纬度坐标。

路径表存储订单的配送路径信息，包括路径点数组、时间数组、当前步骤索引、总步数等。路径点数组以 JSON 格式存储，每个元素是一个包含经度和纬度的数组。时间数组存储到达每个路径点的累计耗时（秒），用于精确控制配送进度。当前步骤索引记录车辆当前所在路径点的位置，总步数记录路径点的总数。

物流时间线表记录订单状态变更历史，包括状态描述、详细描述、位置信息和时间戳。系统在订单创建、发货、位置更新、送达等关键节点自动创建时间线记录，为用户提供完整的物流追踪信息。

配送区域表存储商家定义的配送范围，边界以 GeoJSON 格式存储多边形坐标。系统使用射线法算法判断订单目的地是否在配送区域内，该算法通过从点向任意方向发射射线，统计与多边形边界的交点数量来判断点的位置。

物流公司表存储物流公司信息，包括名称和配送速度系数。速度系数是一个 0 到 1 之间的浮点数，表示配送速度相对开车的比例，系数越小配送越慢。系统根据速度系数和路径距离计算预计配送时间，并引入随机波动系数模拟实际配送中的时间偏差。

## 三、核心功能模块

### 3.1 认证授权模块

认证模块实现了基于 JWT 的认证机制。用户登录时，系统验证用户名和密码，验证通过后生成 JWT Token 返回给客户端。Token 包含用户ID和用户名信息，有效期为 7 天。客户端在后续请求中通过 Authorization 头携带 Token，服务器使用 JWT 策略验证 Token 有效性。

系统实现了路由守卫机制，保护需要认证的接口。JwtAuthGuard 装饰器应用于需要认证的控制器或路由，未携带有效 Token 的请求会被拒绝并返回 401 状态码。前端路由也实现了路由守卫，未登录用户访问商家端页面时自动重定向到登录页。

密码加密使用 bcrypt 算法，哈希轮数为 10。系统在创建商家和验证密码时使用相同的加密参数，确保安全性。数据库不存储明文密码，即使数据库泄露也不会导致密码泄露。

### 3.2 订单管理模块

订单管理模块提供了完整的订单 CRUD 操作。商家可以创建订单、查看订单列表、更新订单信息、删除订单。订单列表支持按状态筛选、多字段排序、分页查询等功能。系统支持批量操作，包括批量发货、批量删除、批量导出 CSV 等。

订单创建时，系统自动生成唯一的订单号，格式为 ORD 开头后跟 20 位字符。订单号生成使用时间戳和随机数组合，确保唯一性。创建订单时，系统根据物流公司的速度系数和路径距离计算预计送达时间，并创建初始时间线记录。

发货操作将订单状态从待发货变更为运输中，并触发路径规划流程。系统首先检查是否已存在路径，如果不存在则调用路径规划服务生成路径。路径规划优先使用高德地图 API 获取真实路径，失败时降级到直线插值。路径生成后，系统创建路径记录并启动定时器，开始模拟配送过程。

订单详情页面显示订单的完整信息，包括收货人信息、商品信息、物流状态、时间线等。系统支持生成二维码和追踪链接，方便用户分享和访问。

### 3.3 路径规划模块

路径规划模块负责为订单生成配送路径。系统优先使用高德地图 Web Service API 的驾车路径规划接口，获取真实的道路路径。API 返回的路径包含多个步骤（Step），每个步骤包含路径点坐标（Polyline）和预计耗时。系统解析这些数据，提取所有路径点并计算到达每个点的累计耗时。

高德 API 返回的时间数组（t0）表示开车到达各路径点的累计耗时。系统根据物流公司的速度系数（speed）计算预计耗时（t_esti = t0 / speed），然后引入随机波动系数（factor，范围 0.85 到 1.2，延迟概率略高于提前）计算实际耗时（t_real = t_esti * factor）。这个时间数组存储在路径表的 timeArray 字段中，用于精确控制配送进度。

当高德 API 不可用时，系统使用直线插值算法生成路径。算法在起点和终点之间均匀分布 20 个路径点，假设车辆以恒定速度直线行驶。虽然这种方式不够真实，但确保了功能的可用性。

路径生成采用队列机制，通过 RouteQueueService 控制并发。系统维护一个待处理队列，每半秒从队列中取出一个订单进行路径生成，避免同时发起大量 API 请求导致限流。路径生成失败时自动重试，最多重试 3 次，超过次数后使用直线插值作为降级方案。

### 3.4 轨迹模拟模块

轨迹模拟模块负责模拟订单的配送过程。系统使用定时任务每 5 秒查询一次所有运输中的订单，计算下一个位置点并更新数据库。实际上，系统为每个订单维护独立的定时器，根据时间数组精确控制每个路径点的到达时间。

定时器机制基于时间数组（t_real）计算相邻路径点的时间差（delta_t），然后根据时间差设置定时器。实际更新间隔 = max(delta_t / 3600, 0.1) 秒，实现 1 秒对应 1 小时的演示加速效果，最小间隔 0.1 秒避免更新过于频繁。

当订单到达终点时，系统自动更新订单状态为已送达，创建签收时间线记录，并通过 WebSocket 广播配送完成事件。系统在服务启动时会自动恢复所有运输中订单的定时器，确保服务重启后配送过程不中断。

位置更新时，系统通过 TrackingGateway 向订阅了该订单的房间广播位置更新事件。事件包含订单号、当前位置、进度百分比、订单状态、预计送达时间等信息。客户端收到事件后更新地图上的车辆图标位置，实现实时追踪效果。

### 3.5 WebSocket 实时通信模块

WebSocket 模块使用 Socket.io 实现实时双向通信。系统实现了订单级别的房间隔离机制，每个订单对应一个独立的房间（Room）。客户端订阅订单时加入对应房间，取消订阅时离开房间。服务器向房间内所有客户端广播事件，实现多客户端同步。

系统定义了三个核心事件：location_update（位置更新）、status_update（状态更新）、delivery_complete（配送完成）。位置更新事件在定时器触发时发送，包含当前位置和进度信息。状态更新事件在订单状态变更时发送，同时发送给订阅房间和所有连接的客户端（用于数据看板实时更新）。配送完成事件在订单送达时发送。

客户端订阅订单时，服务器立即推送当前位置和进度信息，避免用户等待下一个更新周期。这个机制通过查询数据库获取订单的当前状态和位置实现，确保首次订阅的用户能够立即看到订单状态。

系统实现了连接管理，记录每个客户端的连接和断开事件。当客户端断开连接时，系统自动清理相关资源。客户端重连后需要重新订阅订单，系统在重连成功后自动恢复之前的订阅状态。

### 3.6 配送区域管理模块

配送区域管理模块允许商家在地图上绘制配送范围。系统使用高德地图的 PolygonEditor 插件，支持在地图上绘制和编辑多边形区域。商家可以设置区域名称和关联的物流公司，系统根据物流公司的速度系数计算该区域的配送时效。

区域边界以 GeoJSON 格式存储，包含多边形的坐标数组。系统使用射线法算法判断订单目的地是否在配送区域内。射线法从点向任意方向（通常向右）发射一条射线，统计与多边形边界的交点数量。如果交点数量为奇数，则点在多边形内部；如果为偶数，则点在外部。

系统提供了查询指定区域内所有订单的接口，商家可以查看某个配送区域内的订单分布情况。查询时，系统遍历所有订单，使用射线法判断每个订单的目的地是否在区域内，返回符合条件的订单列表。

区域编辑支持修改边界和更新配置信息。系统在更新时验证 GeoJSON 格式的有效性，确保数据的正确性。删除区域时，系统检查是否有订单关联该区域，如果有则提示用户。

### 3.7 数据统计分析模块

数据统计分析模块提供了多维度的数据分析功能。总览统计包括今日订单数、今日金额、运输中订单数、已完成订单数、待发货订单数、已取消订单数等指标。统计数据支持按日期筛选，默认显示当天的数据。

配送区域统计按区域分组统计订单数量和平均配送时长。系统查询所有配送区域，对每个区域统计订单数量和计算平均配送时长。平均配送时长通过订单的实际送达时间减去发货时间计算，只统计已送达的订单。

物流公司统计按物流公司分组统计订单数量、平均配送时长和准时率。准时率通过比较实际送达时间和预计送达时间计算，实际时间早于或等于预计时间的订单视为准时。系统还提供了物流公司对比图表，使用柱状图展示各公司的平均配送时长和准时率。

订单目的地热力图基于历史订单的分布情况生成。系统查询所有已送达订单的目的地坐标，使用高德地图的 HeatMap 插件在地图上渲染热力图。热力图颜色越深表示该区域的订单密度越高，帮助商家了解订单分布规律。

最新订单动态实时显示订单状态变更。系统通过 WebSocket 接收状态更新事件，在数据看板上实时展示订单状态变更信息，包括订单号、状态、时间等。系统支持加载历史动态数据，默认显示最近 20 条记录。

## 四、前端页面设计

### 4.1 商家登录页面

商家登录页面提供用户名和密码输入框，支持表单验证。登录成功后，系统将 Token 存储到 localStorage，并更新全局认证状态。页面使用 Ant Design 的 Form 组件实现表单，支持回车键提交。登录失败时显示错误提示，帮助用户排查问题。

### 4.2 数据看板页面

数据看板页面是商家端的首页，展示关键业务指标和可视化图表。页面顶部是四个统计卡片，分别显示今日订单数、运输中订单数、已完成订单数和今日金额。运输中订单数通过 WebSocket 实时更新，当订单状态变更时自动刷新。

页面中部是配送时效分析图表区域，左侧是地理柱状图，按配送区域统计平均配送时长；右侧是物流公司对比柱状图，展示各公司的平均配送时长和准时率。图表使用 ECharts 渲染，支持交互操作如缩放、数据点提示等。

页面下方是订单目的地热力图，使用高德地图 HeatMap 插件渲染。热力图基于历史订单的目的地坐标生成，颜色越深表示订单密度越高。地图支持缩放和平移，方便商家查看不同区域的订单分布。

页面右侧是最新订单动态列表，实时显示订单状态变更。列表通过 WebSocket 接收状态更新事件，自动添加新记录到列表顶部。系统支持加载更多历史数据，点击按钮加载更早的记录。

### 4.3 订单管理页面

订单管理页面采用左右分栏布局，左侧是订单列表，右侧是地图展示。订单列表使用 Ant Design 的 Table 组件，支持分页、排序、筛选、多选等功能。列表显示订单号、收货人、商品、金额、状态、创建时间等关键信息。

列表支持按状态筛选，包括全部、待发货、运输中、已送达、已取消等选项。支持多字段排序，包括按创建时间、金额、状态等字段升序或降序排列。支持复选框多选，选中多个订单后可以执行批量操作。

批量操作包括批量发货、批量删除、导出 CSV 等。批量发货将选中的待发货订单状态变更为运输中，并触发路径规划。批量删除将选中的订单标记为已取消或直接删除（根据业务规则）。导出 CSV 将选中的订单数据导出为 CSV 文件，方便商家进行数据分析。

地图区域实时显示选中订单的配送信息。当用户选中订单时，地图自动定位到订单的终点，显示终点标记、完整路径线和当前位置标记。如果订单正在配送中，地图还会显示车辆图标和已走过的路径。地图支持缩放和平移，方便查看路径详情。

订单详情通过双击表格行打开，显示订单的完整信息。详情弹窗包括订单基本信息、收货人信息、商品信息、物流状态、时间线等。系统支持生成二维码和追踪链接，方便用户分享和访问。

### 4.4 创建订单页面

创建订单页面提供表单填写功能，包括物流公司选择、收货地址输入、商品信息填写等。收货地址支持两种输入方式：文本输入和地图选点。文本输入支持地址搜索，系统调用高德地图地理编码 API 将地址文本转换为坐标。地图选点允许用户在地图上点击选择位置，系统自动获取坐标并反地理编码为地址文本。

表单填写时，地图实时显示起点（商家默认发货地址）和终点标记，方便用户确认位置。系统根据选择的物流公司和路径距离自动计算预计送达时间，并在表单中显示。

表单提交时，系统验证必填字段和格式，验证通过后调用创建订单 API。创建成功后，系统提示用户并跳转到订单列表页面。如果创建失败，系统显示错误信息，帮助用户排查问题。

### 4.5 配送区域管理页面

配送区域管理页面允许商家在地图上绘制和管理配送区域。页面左侧是区域列表，显示所有已创建的配送区域。列表支持编辑和删除操作，点击编辑按钮可以修改区域配置，点击删除按钮可以删除区域。

页面右侧是地图区域，使用高德地图 PolygonEditor 插件支持绘制和编辑多边形。商家可以点击地图上的点创建多边形顶点，双击完成绘制。已绘制的多边形可以编辑，拖动顶点可以调整形状。系统实时显示多边形的面积和周长，帮助商家了解区域范围。

创建或编辑区域时，商家需要填写区域名称和选择关联的物流公司。系统根据物流公司的速度系数和区域内的典型路径距离计算配送时效，并在表单中显示。保存时，系统将多边形的 GeoJSON 数据存储到数据库。

系统提供了查询区域内订单的功能，商家可以查看某个配送区域内的所有订单。查询时，系统使用射线法算法判断每个订单的目的地是否在区域内，返回符合条件的订单列表。

### 4.6 物流查询页面

物流查询页面是用户端的入口页面，提供订单号输入功能。页面背景显示高德地图，默认定位到北京天安门位置。输入框支持订单号格式验证，订单号必须以 ORD 开头，总长度为 20 位字符。

输入订单号后，用户点击查询按钮或按回车键提交查询。系统调用查询 API 验证订单号是否存在，如果存在则跳转到实时追踪页面，如果不存在则显示错误提示。查询过程中显示加载状态，提升用户体验。

### 4.7 实时追踪页面

实时追踪页面是用户端的核心页面，展示订单的实时配送状态。页面采用上下布局，上方是地图区域，下方是订单信息卡片和物流时间轴。

地图区域显示订单的完整配送信息，包括起点标记、终点标记、完整路径线、已走过路径线、车辆图标等。起点和终点使用不同颜色的标记区分，路径线使用不同样式区分已走过和未走过的路径。车辆图标使用自定义图标，支持平滑移动动画。

车辆图标的位置通过 WebSocket 实时更新。当收到位置更新事件时，系统计算车辆图标的目标位置，使用缓动函数实现平滑移动。缓动函数使用 easeOutCubic 算法，确保移动过程自然流畅。系统通过 requestAnimationFrame 控制动画帧率，避免性能问题。

订单信息卡片显示订单号、状态、进度百分比、物流公司、预计送达时间等关键信息。进度百分比通过当前步骤索引和总步数计算，实时更新。状态使用不同颜色的标签显示，包括待发货、运输中、已送达等。

物流时间轴倒序显示订单状态变更历史，最新的记录显示在最上方。时间轴包括状态描述、详细描述、位置信息和时间戳。系统在订单创建、发货、位置更新、送达等关键节点自动创建时间线记录，为用户提供完整的物流追踪信息。

页面实现了 WebSocket 断线重连机制。当连接断开时，客户端采用指数退避策略进行重连，初始重连间隔为 1 秒，每次重连失败后间隔翻倍，最多重试 5 次。重连成功后，系统自动重新订阅订单，恢复实时追踪功能。页面顶部显示连接状态指示器，实时显示 WebSocket 连接状态，帮助用户了解系统状态。

## 五、API 接口规范

### 5.1 认证接口

POST /auth/login：用户登录接口。请求体包含用户名和密码，系统验证通过后返回 JWT Token 和用户信息。Token 有效期为 7 天，客户端需要在后续请求中携带 Token。

GET /auth/profile：获取当前用户信息接口。需要携带有效的 JWT Token，系统返回用户的基本信息，包括用户ID、用户名、姓名、电话等。

### 5.2 订单管理接口

GET /orders：获取订单列表接口。支持按状态筛选、多字段排序、分页查询。查询参数包括 status（状态筛选）、sortBy（排序字段）、sortOrder（排序方向）、page（页码）、pageSize（每页数量）等。

POST /orders：创建订单接口。请求体包含收货人信息、商品信息、目的地坐标等。系统自动生成订单号，根据物流公司计算预计送达时间，创建初始时间线记录。

GET /orders/:id：获取订单详情接口。返回订单的完整信息，包括基本信息、路径信息、时间线等。

PATCH /orders/:id：更新订单接口。支持更新订单的部分字段，如收货人信息、商品信息等。系统验证字段有效性，更新后返回更新后的订单信息。

DELETE /orders/:id：删除订单接口。将订单状态变更为已取消，或直接删除订单（根据业务规则）。

POST /orders/ship：发货接口。请求体包含订单ID，系统将订单状态变更为运输中，触发路径规划，创建路径记录，启动定时器。

POST /orders/batch-ship：批量发货接口。请求体包含订单ID数组，系统批量处理发货操作。

POST /orders/batch-delete：批量删除接口。请求体包含订单ID数组，系统批量删除订单。

GET /orders/export：导出订单接口。支持导出 CSV 格式的订单数据，查询参数支持筛选和排序。

### 5.3 路径规划接口

路径规划接口主要供内部调用，不直接暴露给前端。系统在订单发货时自动调用路径规划服务，生成配送路径。路径规划优先使用高德地图 API，失败时降级到直线插值。

### 5.4 配送区域接口

GET /delivery-zones：获取配送区域列表接口。返回当前商家的所有配送区域，包括区域ID、名称、边界、物流公司等信息。

POST /delivery-zones：创建配送区域接口。请求体包含区域名称、边界坐标（GeoJSON 格式）、物流公司等。系统验证 GeoJSON 格式有效性，保存到数据库。

GET /delivery-zones/:id：获取配送区域详情接口。返回区域的完整信息。

PATCH /delivery-zones/:id：更新配送区域接口。支持更新区域名称、边界、物流公司等配置。

DELETE /delivery-zones/:id：删除配送区域接口。系统检查是否有订单关联该区域，如果有则提示用户。

GET /delivery-zones/:id/orders：获取区域内订单接口。使用射线法算法判断订单目的地是否在区域内，返回符合条件的订单列表。

### 5.5 物流公司接口

GET /logistics-companies：获取物流公司列表接口。返回所有物流公司的信息，包括名称、速度系数等。系统预置了 6 家物流公司，包括顺丰速运、圆通速递、中通快递、韵达速递、申通快递、百世快递等。

### 5.6 统计数据接口

GET /statistics/overview：获取总览统计接口。返回今日订单数、今日金额、运输中订单数、已完成订单数等指标。支持按日期筛选，查询参数包括 date（日期，格式 YYYY-MM-DD）。

GET /statistics/zones：获取配送区域统计接口。按区域分组统计订单数量和平均配送时长，返回区域名称、订单数量、平均配送时长等数据。

GET /statistics/logistics：获取物流公司统计接口。按物流公司分组统计订单数量、平均配送时长和准时率，返回公司名称、订单数量、平均配送时长、准时率等数据。

### 5.7 WebSocket 接口

WebSocket 连接地址为 /socket.io/，使用 Socket.io 协议。客户端连接后可以订阅订单追踪，服务器向订阅房间广播位置更新和状态变更事件。

客户端事件包括：subscribe（订阅订单，参数为订单号）、unsubscribe（取消订阅，参数为订单号）、console_log（浏览器控制台日志，用于调试）。

服务器事件包括：location_update（位置更新，包含订单号、当前位置、进度、状态等）、status_update（状态更新，包含订单号、状态、消息等）、delivery_complete（配送完成，包含订单号、状态、实际送达时间等）。

## 六、系统特性

### 6.1 智能路径规划

系统实现了智能路径规划功能，优先使用高德地图 API 获取真实道路路径。高德 API 返回的路径包含多个步骤和路径点，系统解析这些数据生成包含 50+ 路径点的详细路径。路径点的时间信息通过 API 返回的耗时数据计算，考虑物流公司的速度系数和随机波动，生成真实的时间数组。

当高德 API 不可用时，系统自动降级到直线插值算法，在起点和终点之间均匀分布 20 个路径点。虽然这种方式不够真实，但确保了功能的可用性，不会因为外部服务故障导致系统不可用。

路径生成采用队列机制，控制并发请求避免触发 API 限流。系统每半秒处理一个订单的路径生成请求，失败时自动重试最多 3 次。这种机制既保证了路径生成的效率，又避免了因频繁请求导致的限流问题。

### 6.2 精确时间控制

系统实现了精确的时间控制机制，基于时间数组（t_real）精确控制每个路径点的到达时间。时间数组存储到达每个路径点的累计耗时（秒），系统根据相邻路径点的时间差设置定时器，实现 1 秒对应 1 小时的演示加速效果。

时间计算考虑了多个因素：高德 API 返回的开车耗时（t0）、物流公司的速度系数（speed）、订单的随机波动系数（factor）。最终的时间数组（t_real = t0 / speed * factor）既考虑了物流公司的配送速度，又引入了随机性模拟实际配送中的时间偏差。

系统为每个订单维护独立的定时器，根据时间数组精确控制配送进度。当订单到达终点时，系统自动更新订单状态为已送达，创建签收时间线记录。这种机制确保了配送过程的真实性和可控性。

### 6.3 实时数据同步

系统通过 WebSocket 实现实时数据同步，支持订单级别的房间隔离。每个订单对应一个独立的房间，客户端订阅订单时加入房间，服务器向房间内所有客户端广播事件。这种机制实现了多客户端同步，多个用户同时追踪同一个订单时，所有用户都能看到实时的位置更新。

系统实现了首次订阅立即推送机制，客户端订阅订单时服务器立即查询数据库获取当前位置和进度，无需等待下一个更新周期。这个机制提升了用户体验，用户打开追踪页面后立即能看到订单状态。

数据看板通过 WebSocket 接收状态更新事件，实时更新运输中订单数等指标。系统同时向订阅房间和所有连接的客户端广播状态更新事件，确保数据看板和追踪页面都能收到更新。

### 6.4 地理空间计算

系统实现了地理空间计算功能，使用射线法算法判断点是否在多边形内部。射线法从点向任意方向（通常向右）发射一条射线，统计与多边形边界的交点数量。如果交点数量为奇数，则点在多边形内部；如果为偶数，则点在外部。

系统使用 Haversine 公式计算两点之间的距离，考虑地球的曲率提供更准确的距离计算。这个公式在计算较短距离时精度较高，适合物流配送场景。

配送区域管理使用 GeoJSON 格式存储多边形边界，支持复杂的多边形形状。系统在创建和更新区域时验证 GeoJSON 格式的有效性，确保数据的正确性。查询区域内订单时，系统遍历所有订单，使用射线法判断每个订单的目的地是否在区域内。

### 6.5 自动化轨迹模拟

系统实现了自动化轨迹模拟功能，使用定时任务模拟订单的配送过程。系统为每个订单维护独立的定时器，根据时间数组精确控制每个路径点的到达时间。当订单发货时，系统自动生成路径并启动定时器，开始模拟配送。

定时器机制基于时间数组计算相邻路径点的时间差，然后根据时间差设置定时器。实际更新间隔 = max(delta_t / 3600, 0.1) 秒，实现 1 秒对应 1 小时的演示加速效果，最小间隔 0.1 秒避免更新过于频繁。

系统在服务启动时会自动恢复所有运输中订单的定时器，确保服务重启后配送过程不中断。这个机制通过查询数据库获取所有运输中的订单，为每个订单重新创建定时器实现。

位置更新时，系统通过 WebSocket 向订阅房间广播位置更新事件，客户端收到事件后更新地图上的车辆图标位置。当订单到达终点时，系统自动更新订单状态为已送达，创建签收时间线记录，并通过 WebSocket 广播配送完成事件。

### 6.6 断线重连机制

系统实现了 WebSocket 断线重连机制，采用指数退避策略进行重连。初始重连间隔为 1 秒，每次重连失败后间隔翻倍，最多重试 5 次。重连成功后，系统自动重新订阅之前订阅的订单，恢复实时追踪功能。

客户端在连接断开时显示连接状态指示器，提示用户连接已断开。重连过程中，系统继续尝试重连，并在重连成功后自动恢复功能。这个机制确保了用户体验的连续性，即使网络出现短暂中断，系统也能自动恢复。

系统在页面顶部显示连接状态指示器，实时显示 WebSocket 连接状态。连接正常时显示绿色指示器，连接断开时显示红色指示器，重连过程中显示黄色指示器。这个机制帮助用户了解系统状态，提升用户体验。

## 七、部署说明

### 7.1 环境要求

系统运行需要 Node.js 18+ 环境，推荐使用 pnpm 作为包管理器。数据库使用 PostgreSQL 12+ 配合 PostGIS 扩展，可以通过 Docker Compose 一键启动。系统需要高德地图 API Key，前端需要 JS API Key，后端需要 Web Service API Key（可选）。

### 7.2 数据库配置

数据库使用 Docker Compose 管理，配置文件位于项目根目录的 docker-compose.yml。启动数据库容器后，系统会自动创建数据库和表结构。数据库连接信息通过环境变量配置，包括数据库地址、端口、用户名、密码等。

系统使用 Prisma 管理数据库迁移，开发环境使用 `npx prisma db push` 同步数据库结构，生产环境使用 `npx prisma migrate deploy` 执行迁移。数据库初始化后，系统会自动执行种子脚本，创建测试数据和预置的物流公司信息。

### 7.3 后端部署

后端服务使用 NestJS 框架，开发环境使用 `pnpm start:dev` 启动，支持热重载。生产环境使用 `pnpm build` 构建，然后使用 `pnpm start:prod` 启动。系统支持通过环境变量配置端口、数据库连接、JWT 密钥、高德 API Key 等。

系统实现了完整的错误处理和日志记录，生产环境建议配置日志收集和监控系统。WebSocket 服务需要特殊配置，Nginx 反向代理时需要配置 WebSocket 支持，包括 `proxy_http_version 1.1`、`Upgrade` 和 `Connection` 头等。

### 7.4 前端部署

前端应用使用 Vite 构建，开发环境使用 `pnpm dev` 启动，生产环境使用 `pnpm build` 构建。构建产物位于 dist 目录，可以部署到任何静态文件服务器，如 Nginx、Apache 等。

前端需要配置环境变量，包括 API 地址、高德地图 JS API Key 和安全密钥。环境变量通过 `.env` 文件配置，构建时会被注入到代码中。生产环境建议使用环境变量管理工具，避免将敏感信息提交到代码仓库。

### 7.5 测试

系统包含完整的测试套件，包括单元测试和端到端测试。单元测试使用 Jest 框架，覆盖核心服务和工具函数。端到端测试模拟完整的业务流程，验证系统的功能正确性。

运行测试前需要启动后端服务，端到端测试会调用真实的 API 接口。测试覆盖率报告通过 `pnpm test:cov` 生成，可以在 coverage 目录查看详细的覆盖率信息。

系统提供了演示脚本，可以快速验证系统功能。演示脚本包括完整流程演示和交互式菜单演示，展示系统的核心能力。运行演示脚本可以快速了解系统的功能和使用方法。

## 八、总结

电商物流配送可视化平台是一个功能完整、技术先进的全栈物流管理系统。系统实现了从商家创建订单到用户实时追踪的完整业务闭环，提供了丰富的可视化功能和数据分析能力。系统采用现代化的技术栈，代码结构清晰，遵循最佳实践，具有良好的可维护性和可扩展性。

系统在路径规划、时间控制、实时通信、地理空间计算等方面实现了创新和优化，提供了真实可靠的配送模拟和流畅的用户体验。系统支持完整的测试覆盖，确保了功能的正确性和稳定性。系统设计考虑了生产环境的需求，提供了完善的部署方案和配置说明。

项目展示了全栈开发的能力，涵盖了前端可视化、后端服务、数据库设计、实时通信、地理空间计算等多个技术领域。系统可以作为电商物流场景的完整解决方案，也可以作为学习全栈开发的优秀案例。

